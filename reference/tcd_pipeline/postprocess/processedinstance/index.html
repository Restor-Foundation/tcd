
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../postprocessor/">
      
      
        <link rel="next" href="../semanticprocessor/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.21">
    
    
      
        <title>processedinstance - Restor Tree Crown Delineation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tcd_pipeline.postprocess.processedinstance" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Restor Tree Crown Delineation" class="md-header__button md-logo" aria-label="Restor Tree Crown Delineation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Restor Tree Crown Delineation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              processedinstance
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Restor Tree Crown Delineation" class="md-nav__button md-logo" aria-label="Restor Tree Crown Delineation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Restor Tree Crown Delineation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../predictions.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Predicting
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../training/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../citing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Citation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../acknowledgements.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acknowledgements
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pipeline architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" checked>
        
          
          <label class="md-nav__link" for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tcd_pipeline
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_1">
            <span class="md-nav__icon md-icon"></span>
            tcd_pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_2" >
        
          
          <label class="md-nav__link" for="__nav_9_1_2" id="__nav_9_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    cache
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_2">
            <span class="md-nav__icon md-icon"></span>
            cache
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cache/cache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cache
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cache/instance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    instance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cache/semantic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    semantic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_3" >
        
          
          <label class="md-nav__link" for="__nav_9_1_3" id="__nav_9_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_3">
            <span class="md-nav__icon md-icon"></span>
            data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/cocodataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cocodataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/datamodule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    datamodule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/imagedataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    imagedataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/tiling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tiling
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_4" >
        
          
          <label class="md-nav__link" for="__nav_9_1_4" id="__nav_9_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_4">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/instance_segmentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    instance_segmentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/segformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    segformer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/segformermodule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    segformermodule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/segmentationmodule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    segmentationmodule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/semantic_segmentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    semantic_segmentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/smp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/smpmodule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    smpmodule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/train_instance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    train_instance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/train_semantic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    train_semantic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_6" checked>
        
          
          <label class="md-nav__link" for="__nav_9_1_6" id="__nav_9_1_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    postprocess
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_1_6">
            <span class="md-nav__icon md-icon"></span>
            postprocess
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../instanceprocessor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    instanceprocessor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../postprocessor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    postprocessor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    processedinstance
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    processedinstance
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance" class="md-nav__link">
    <span class="md-ellipsis">
      processedinstance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance" class="md-nav__link">
    <span class="md-ellipsis">
      ProcessedInstance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ProcessedInstance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.local_mask" class="md-nav__link">
    <span class="md-ellipsis">
      local_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.polygon" class="md-nav__link">
    <span class="md-ellipsis">
      polygon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.from_coco_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_coco_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.get_image" class="md-nav__link">
    <span class="md-ellipsis">
      get_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.get_pixels" class="md-nav__link">
    <span class="md-ellipsis">
      get_pixels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.to_coco_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_coco_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.transformed_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      transformed_polygon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.update" class="md-nav__link">
    <span class="md-ellipsis">
      update
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.dump_instances_coco" class="md-nav__link">
    <span class="md-ellipsis">
      dump_instances_coco
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.non_max_suppression" class="md-nav__link">
    <span class="md-ellipsis">
      non_max_suppression
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semanticprocessor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    semanticprocessor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    report
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1_8" >
        
          
          <label class="md-nav__link" for="__nav_9_1_8" id="__nav_9_1_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    result
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1_8">
            <span class="md-nav__icon md-icon"></span>
            result
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../result/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../result/instancesegmentationresult/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    instancesegmentationresult
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../result/processedresult/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    processedresult
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../result/semanticsegmentationresult/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    semanticsegmentationresult
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    util
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance" class="md-nav__link">
    <span class="md-ellipsis">
      processedinstance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance" class="md-nav__link">
    <span class="md-ellipsis">
      ProcessedInstance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ProcessedInstance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.local_mask" class="md-nav__link">
    <span class="md-ellipsis">
      local_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.polygon" class="md-nav__link">
    <span class="md-ellipsis">
      polygon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.from_coco_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_coco_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.get_image" class="md-nav__link">
    <span class="md-ellipsis">
      get_image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.get_pixels" class="md-nav__link">
    <span class="md-ellipsis">
      get_pixels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.to_coco_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_coco_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.transformed_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      transformed_polygon
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance.update" class="md-nav__link">
    <span class="md-ellipsis">
      update
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.dump_instances_coco" class="md-nav__link">
    <span class="md-ellipsis">
      dump_instances_coco
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcd_pipeline.postprocess.processedinstance.non_max_suppression" class="md-nav__link">
    <span class="md-ellipsis">
      non_max_suppression
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>processedinstance</h1>

<div class="doc doc-object doc-module">



<a id="tcd_pipeline.postprocess.processedinstance"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance" class="doc doc-heading">
          <code>ProcessedInstance</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Contains a processed instance that is detected by the model. Contains the score the algorithm gave, a polygon for the object,
a bounding box and a local mask (a boolean mask of the size of the bounding box)</p>
<p>If compression is enabled, then instance masks are automatically stored as memory-efficient objects. Currently two options are
possible, either using the coco API ('coco') or scipy sparse arrays ('sparse').</p>

            <details class="quote">
              <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ProcessedInstance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains a processed instance that is detected by the model. Contains the score the algorithm gave, a polygon for the object,</span>
<span class="sd">    a bounding box and a local mask (a boolean mask of the size of the bounding box)</span>

<span class="sd">    If compression is enabled, then instance masks are automatically stored as memory-efficient objects. Currently two options are</span>
<span class="sd">    possible, either using the coco API (&#39;coco&#39;) or scipy sparse arrays (&#39;sparse&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">score</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">bbox</span><span class="p">:</span> <span class="n">box</span><span class="p">,</span>
        <span class="n">class_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
        <span class="n">global_polygon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">local_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the instance</span>

<span class="sd">        Args:</span>
<span class="sd">            score (float): score given to the instance, or if a list, interpret as per-class scores</span>
<span class="sd">            bbox (box): the bounding box of the object</span>
<span class="sd">            class_index (int): the class index of the object</span>
<span class="sd">            compress (optional, str): array compression method, defaults to coco</span>
<span class="sd">            global_polygon (MultiPolygon): a shapely MultiPolygon describing the segmented object in global image coordinates</span>
<span class="sd">            local_mask (array): local 2D binary mask for the instance</span>
<span class="sd">            label (optional, int): label associated with the processedInstance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">score</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">class_index</span><span class="p">,</span> <span class="n">compress</span><span class="p">,</span> <span class="n">global_polygon</span><span class="p">,</span> <span class="n">local_mask</span><span class="p">,</span> <span class="n">label</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">score</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">bbox</span><span class="p">:</span> <span class="n">box</span><span class="p">,</span>
        <span class="n">class_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
        <span class="n">global_polygon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">local_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the instance</span>

<span class="sd">        Args:</span>
<span class="sd">            score (float): score given to the instance</span>
<span class="sd">            bbox (box): the bounding box of the object</span>
<span class="sd">            class_index (int): the class index of the object</span>
<span class="sd">            compress (optional, str): array compression method, defaults to coco</span>
<span class="sd">            global_polygon (MultiPolygon): a shapely MultiPolygon describing the segmented object in global image coordinates</span>
<span class="sd">            local_mask (array): local 2D binary mask for the instance</span>
<span class="sd">            label (optional, int): label associated with the processedInstance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span> <span class="o">=</span> <span class="n">score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_index</span> <span class="o">=</span> <span class="n">class_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="c1"># For most cases, we only need to store the mask:</span>
        <span class="k">if</span> <span class="n">local_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span> <span class="o">=</span> <span class="n">local_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># If a polygon is supplied store it, but default None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="o">=</span> <span class="n">global_polygon</span>

    <span class="k">def</span> <span class="nf">_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method to compress a local annotation mask</span>
<span class="sd">        use &#39;coco&#39; to store RLE encoded masks. Use &#39;sparse&#39;</span>
<span class="sd">        to store scipy sparse arrays, or None to disable.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (array): mask array</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: compressed mask</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">==</span> <span class="s2">&quot;coco&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">==</span> <span class="s2">&quot;sparse&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="si">}</span><span class="s2"> is not a valid compression method&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method to decompress a local annotation mask</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (Any): compressed mask</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: uncompressed mask</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">==</span> <span class="s2">&quot;coco&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">==</span> <span class="s2">&quot;sparse&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="si">}</span><span class="s2"> is not a valid compression method&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the local annotation mask.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: local annotation mask</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>

            <span class="n">local_polygon</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span><span class="p">,</span> <span class="n">xoff</span><span class="o">=-</span><span class="n">minx</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=-</span><span class="n">miny</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span> <span class="o">=</span> <span class="n">polygon_to_mask</span><span class="p">(</span><span class="n">local_polygon</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_mask</span><span class="p">)</span>

    <span class="nd">@local_mask</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">local_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal function for setting local annotation mask, compresses</span>
<span class="sd">        using the specified method (e.g. coco, pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">(</span><span class="n">local_mask</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the polygon associated with this instance, creates it if</span>
<span class="sd">        it doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_polygon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span>

    <span class="k">def</span> <span class="nf">transformed_polygon</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="n">affine</span><span class="o">.</span><span class="n">Affine</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform polygon to world coordinates given an affine transform (typically</span>
<span class="sd">        obtained from a rasterio image&#39;s .transform property)</span>

<span class="sd">        Args:</span>
<span class="sd">            transform (affine.Affine): affine transform</span>

<span class="sd">        Returns:</span>
<span class="sd">            polygon (shapely.geometry.MultiPolygon): the polygon in world coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Re-order rasterio affine transform to shapely and map pixels -&gt; world</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">xoff</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">yoff</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">affine_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal function to generate polygon associated with mask&quot;&quot;&quot;</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">mask_to_polygon</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="c1"># Positive offset into full image</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">xoff</span><span class="o">=</span><span class="n">minx</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=</span><span class="n">miny</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pixels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">rasterio</span><span class="o">.</span><span class="n">DatasetReader</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the pixel values of the image at the location of the object</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.array[int]): image</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array[int]: pixel values at the location of the object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">DatasetReader</span><span class="p">):</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">roi</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the masked image at the location of the object</span>
<span class="sd">        Args:</span>
<span class="sd">                image (np.array(int)): image</span>
<span class="sd">        Returns:</span>
<span class="sd">                np.array(int): pixel values at the location of the object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_coco_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">annotation</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">image_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">global_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates an instance from a COCO dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotation (dict): COCO formatted annotation dictionary</span>
<span class="sd">            image_shape (int): shape of the image</span>
<span class="sd">            global_mask (bool): specifies whether masks are stored in local or global coordinates.</span>
<span class="sd">                                This is overridden if the annotation file specifies that global</span>
<span class="sd">                                coords are used.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">score</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Override score if we have per-class predictions</span>
        <span class="k">if</span> <span class="s2">&quot;class_scores&quot;</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;class_scores&quot;</span><span class="p">]</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>

        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">image_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span>

        <span class="n">bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">miny</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">class_index</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If &#39;counts&#39; is not RLE encoded we need to convert it.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
                <span class="n">rle</span> <span class="o">=</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">frPyObjects</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rle</span>

            <span class="n">local_mask</span> <span class="o">=</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">global_mask</span> <span class="ow">and</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Requesting a global mask, but the annotation format is in local coordinates&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">global_mask</span> <span class="ow">or</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If the mask is stored in global coordinates, then we expect the encoded mask</span>
                <span class="c1"># to be the shape of the source image. Here, extract/crop the local mask from</span>
                <span class="c1"># the global one.</span>
                <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">local_mask</span> <span class="o">=</span> <span class="n">local_mask</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]</span>

            <span class="n">polygon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Polygon annotations are always global</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span>
            <span class="n">local_polygon</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">xoff</span><span class="o">=-</span><span class="n">minx</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=-</span><span class="n">miny</span><span class="p">)</span>
            <span class="n">local_mask</span> <span class="o">=</span> <span class="n">polygon_to_mask</span><span class="p">(</span><span class="n">local_polygon</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">([</span><span class="n">polygon</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">score</span><span class="p">,</span>
            <span class="n">bbox</span><span class="p">,</span>
            <span class="n">class_index</span><span class="p">,</span>
            <span class="n">global_polygon</span><span class="o">=</span><span class="n">polygon</span><span class="p">,</span>
            <span class="n">local_mask</span><span class="o">=</span><span class="n">local_mask</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mask_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function to encode an annotation mask in COCO format. Currently</span>
<span class="sd">        this uses pycocotools, but faster implementations may be available in the</span>
<span class="sd">        future.</span>

<span class="sd">        Args:</span>
<span class="sd">            annotation (npt.NDArray): 2D annotation mask</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: encoded segmentation object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">to_coco_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">instance_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">global_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">image_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Outputs a COCO dictionary in global image coordinates. Will automatically</span>
<span class="sd">        pick whether to store a polygon (if the annotation is simple) or a RLE</span>
<span class="sd">        encoded mask. You can store masks in local or global coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): image ID that this annotation corresponds to</span>
<span class="sd">            instance_id (int): instance ID - should be unique</span>
<span class="sd">            global_mask (bool): store masks in global coords (possibly CPU and nmemory intensive to compute)</span>
<span class="sd">            image_shape (tuple(int, int), optional): image shape, must be provided if global masks are used</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: COCO format dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_id</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;image_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_id</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_index</span><span class="p">)</span>

        <span class="c1"># Store both predicted class score, and class score vector</span>
        <span class="c1"># as other software might not know how to deal with per</span>
        <span class="c1"># class predictions</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;class_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span><span class="p">]</span>

        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span>

        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">minx</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">miny</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">height</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If the polygon has holes:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">geoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># For simplicity, always store as a RLE mask</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">global_mask</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">image_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">coco_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">coco_mask</span><span class="p">[</span>
                    <span class="n">miny</span> <span class="p">:</span> <span class="n">miny</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">minx</span> <span class="p">:</span> <span class="n">minx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">coco_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span>

            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_encode</span><span class="p">(</span><span class="n">coco_mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;counts&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Polygons are always stored in global image coords</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">exterior_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">exterior_coords</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">geoms</span>
                <span class="p">]</span>

            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coord</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">exterior_coords</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xy</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">annotation</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ProcessedInstance(score=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, class=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_index</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.local_mask" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">local_mask</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the local annotation mask.</p>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.array: local annotation mask</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">polygon</span><span class="p">:</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the polygon associated with this instance, creates it if
it doesn't exist.</p>
  </div>

</div>




<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">class_index</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s1">&#39;sparse&#39;</span><span class="p">,</span> <span class="n">global_polygon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">local_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initializes the instance</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>score</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>score given to the instance, or if a list, interpret as per-class scores</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>bbox</code></td>
          <td>
                <code><span title="shapely.geometry.box">box</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the bounding box of the object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>class_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the class index of the object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>compress</code></td>
          <td>
                <code>(optional, str)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>array compression method, defaults to coco</p>
            </div>
          </td>
          <td>
                <code>&#39;sparse&#39;</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>global_polygon</code></td>
          <td>
                <code>MultiPolygon</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a shapely MultiPolygon describing the segmented object in global image coordinates</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>local_mask</code></td>
          <td>
                <code>array</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local 2D binary mask for the instance</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>label</code></td>
          <td>
                <code>(optional, int)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>label associated with the processedInstance</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">score</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="n">box</span><span class="p">,</span>
    <span class="n">class_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
    <span class="n">global_polygon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the instance</span>

<span class="sd">    Args:</span>
<span class="sd">        score (float): score given to the instance, or if a list, interpret as per-class scores</span>
<span class="sd">        bbox (box): the bounding box of the object</span>
<span class="sd">        class_index (int): the class index of the object</span>
<span class="sd">        compress (optional, str): array compression method, defaults to coco</span>
<span class="sd">        global_polygon (MultiPolygon): a shapely MultiPolygon describing the segmented object in global image coordinates</span>
<span class="sd">        local_mask (array): local 2D binary mask for the instance</span>
<span class="sd">        label (optional, int): label associated with the processedInstance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">score</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">class_index</span><span class="p">,</span> <span class="n">compress</span><span class="p">,</span> <span class="n">global_polygon</span><span class="p">,</span> <span class="n">local_mask</span><span class="p">,</span> <span class="n">label</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.from_coco_dict" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">from_coco_dict</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">image_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">global_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Instantiates an instance from a COCO dictionary.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>annotation</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>COCO formatted annotation dictionary</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>image_shape</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>shape of the image</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>global_mask</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>specifies whether masks are stored in local or global coordinates.
                This is overridden if the annotation file specifies that global
                coords are used.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_coco_dict</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">annotation</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">image_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">global_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiates an instance from a COCO dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation (dict): COCO formatted annotation dictionary</span>
<span class="sd">        image_shape (int): shape of the image</span>
<span class="sd">        global_mask (bool): specifies whether masks are stored in local or global coordinates.</span>
<span class="sd">                            This is overridden if the annotation file specifies that global</span>
<span class="sd">                            coords are used.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Override score if we have per-class predictions</span>
    <span class="k">if</span> <span class="s2">&quot;class_scores&quot;</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;class_scores&quot;</span><span class="p">]</span>

    <span class="n">label</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>

    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">image_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span>

    <span class="n">bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">miny</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">class_index</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># If &#39;counts&#39; is not RLE encoded we need to convert it.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
            <span class="n">rle</span> <span class="o">=</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">frPyObjects</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rle</span>

        <span class="n">local_mask</span> <span class="o">=</span> <span class="n">coco_mask</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">global_mask</span> <span class="ow">and</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Requesting a global mask, but the annotation format is in local coordinates&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">global_mask</span> <span class="ow">or</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If the mask is stored in global coordinates, then we expect the encoded mask</span>
            <span class="c1"># to be the shape of the source image. Here, extract/crop the local mask from</span>
            <span class="c1"># the global one.</span>
            <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
            <span class="n">local_mask</span> <span class="o">=</span> <span class="n">local_mask</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]</span>

        <span class="n">polygon</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Polygon annotations are always global</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span>
        <span class="n">local_polygon</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">xoff</span><span class="o">=-</span><span class="n">minx</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=-</span><span class="n">miny</span><span class="p">)</span>
        <span class="n">local_mask</span> <span class="o">=</span> <span class="n">polygon_to_mask</span><span class="p">(</span><span class="n">local_polygon</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">([</span><span class="n">polygon</span><span class="p">])</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">score</span><span class="p">,</span>
        <span class="n">bbox</span><span class="p">,</span>
        <span class="n">class_index</span><span class="p">,</span>
        <span class="n">global_polygon</span><span class="o">=</span><span class="n">polygon</span><span class="p">,</span>
        <span class="n">local_mask</span><span class="o">=</span><span class="n">local_mask</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.get_image" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Gets the masked image at the location of the object
Args:
        image (np.array(int)): image
Returns:
        np.array(int): pixel values at the location of the object</p>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the masked image at the location of the object</span>
<span class="sd">    Args:</span>
<span class="sd">            image (np.array(int)): image</span>
<span class="sd">    Returns:</span>
<span class="sd">            np.array(int): pixel values at the location of the object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.get_pixels" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_pixels</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Gets the pixel values of the image at the location of the object</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>image</code></td>
          <td>
                <code><span title="numpy.array">array</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.array[int]: pixel values at the location of the object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_pixels</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">rasterio</span><span class="o">.</span><span class="n">DatasetReader</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the pixel values of the image at the location of the object</span>

<span class="sd">    Args:</span>
<span class="sd">        image (np.array[int]): image</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array[int]: pixel values at the location of the object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">DatasetReader</span><span class="p">):</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">,</span> <span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">roi</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.to_coco_dict" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">to_coco_dict</span><span class="p">(</span><span class="n">image_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">instance_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">global_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Outputs a COCO dictionary in global image coordinates. Will automatically
pick whether to store a polygon (if the annotation is simple) or a RLE
encoded mask. You can store masks in local or global coordinates.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>image_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>image ID that this annotation corresponds to</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>instance_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>instance ID - should be unique</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>global_mask</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>store masks in global coords (possibly CPU and nmemory intensive to compute)</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>image_shape</code></td>
          <td>
                <code>tuple(int, int)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>image shape, must be provided if global masks are used</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
<td><code>dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>COCO format dictionary</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_coco_dict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">instance_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">global_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">image_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Outputs a COCO dictionary in global image coordinates. Will automatically</span>
<span class="sd">    pick whether to store a polygon (if the annotation is simple) or a RLE</span>
<span class="sd">    encoded mask. You can store masks in local or global coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_id (int): image ID that this annotation corresponds to</span>
<span class="sd">        instance_id (int): instance ID - should be unique</span>
<span class="sd">        global_mask (bool): store masks in global coords (possibly CPU and nmemory intensive to compute)</span>
<span class="sd">        image_shape (tuple(int, int), optional): image shape, must be provided if global masks are used</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: COCO format dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_id</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;image_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_id</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;category_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_index</span><span class="p">)</span>

    <span class="c1"># Store both predicted class score, and class score vector</span>
    <span class="c1"># as other software might not know how to deal with per</span>
    <span class="c1"># class predictions</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;class_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span><span class="p">]</span>

    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">maxy</span> <span class="o">-</span> <span class="n">miny</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span>

    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">minx</span><span class="p">),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">miny</span><span class="p">),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">),</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">height</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># If the polygon has holes:</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">geoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="c1"># For simplicity, always store as a RLE mask</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">global_mask</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">image_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">coco_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">coco_mask</span><span class="p">[</span>
                <span class="n">miny</span> <span class="p">:</span> <span class="n">miny</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">minx</span> <span class="p">:</span> <span class="n">minx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">coco_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span>

        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_encode</span><span class="p">(</span><span class="n">coco_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">][</span>
                <span class="s2">&quot;counts&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Polygons are always stored in global image coords</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;global&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;iscrowd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exterior_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">exterior_coords</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">geoms</span>
            <span class="p">]</span>

        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">coord</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="n">exterior_coords</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xy</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="n">annotation</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.transformed_polygon" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">transformed_polygon</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Transform polygon to world coordinates given an affine transform (typically
obtained from a rasterio image's .transform property)</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>transform</code></td>
          <td>
                <code><span title="affine.Affine">Affine</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>affine transform</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
<td><code>polygon</code></td>          <td>
                <code><span title="shapely.geometry.MultiPolygon">MultiPolygon</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the polygon in world coordinates</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transformed_polygon</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="n">affine</span><span class="o">.</span><span class="n">Affine</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform polygon to world coordinates given an affine transform (typically</span>
<span class="sd">    obtained from a rasterio image&#39;s .transform property)</span>

<span class="sd">    Args:</span>
<span class="sd">        transform (affine.Affine): affine transform</span>

<span class="sd">    Returns:</span>
<span class="sd">        polygon (shapely.geometry.MultiPolygon): the polygon in world coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Re-order rasterio affine transform to shapely and map pixels -&gt; world</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">transform</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">xoff</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">yoff</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">affine_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="tcd_pipeline.postprocess.processedinstance.ProcessedInstance.update" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">update</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">class_index</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s1">&#39;sparse&#39;</span><span class="p">,</span> <span class="n">global_polygon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">local_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Updates the instance</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>score</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>score given to the instance</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>bbox</code></td>
          <td>
                <code><span title="shapely.geometry.box">box</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the bounding box of the object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>class_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the class index of the object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>compress</code></td>
          <td>
                <code>(optional, str)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>array compression method, defaults to coco</p>
            </div>
          </td>
          <td>
                <code>&#39;sparse&#39;</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>global_polygon</code></td>
          <td>
                <code>MultiPolygon</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a shapely MultiPolygon describing the segmented object in global image coordinates</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>local_mask</code></td>
          <td>
                <code>array</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>local 2D binary mask for the instance</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>label</code></td>
          <td>
                <code>(optional, int)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>label associated with the processedInstance</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">score</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="n">box</span><span class="p">,</span>
    <span class="n">class_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
    <span class="n">global_polygon</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the instance</span>

<span class="sd">    Args:</span>
<span class="sd">        score (float): score given to the instance</span>
<span class="sd">        bbox (box): the bounding box of the object</span>
<span class="sd">        class_index (int): the class index of the object</span>
<span class="sd">        compress (optional, str): array compression method, defaults to coco</span>
<span class="sd">        global_polygon (MultiPolygon): a shapely MultiPolygon describing the segmented object in global image coordinates</span>
<span class="sd">        local_mask (array): local 2D binary mask for the instance</span>
<span class="sd">        label (optional, int): label associated with the processedInstance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_scores</span> <span class="o">=</span> <span class="n">score</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_local_mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">class_index</span> <span class="o">=</span> <span class="n">class_index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

    <span class="c1"># For most cases, we only need to store the mask:</span>
    <span class="k">if</span> <span class="n">local_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_mask</span> <span class="o">=</span> <span class="n">local_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># If a polygon is supplied store it, but default None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_polygon</span> <span class="o">=</span> <span class="n">global_polygon</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>



<div class="doc doc-object doc-function">



<h2 id="tcd_pipeline.postprocess.processedinstance.dump_instances_coco" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">dump_instances_coco</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">instances</span><span class="o">=</span><span class="p">[],</span> <span class="n">image_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Store a list of instances as a COCO formatted JSON file.</p>
<p>If an image path is provided then some info will be stored in the file. This utility
is designed to aid with serialising tiled predictions. Typically COCO
format results just reference an image ID, however for predictions over
large orthomosaics we typically only have a single image, so the ID is
set here to zero and we provide information in the annotation file
directly. This is just for compatibility.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>output_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to output json file. Intermediate folders
               will be created if necessary.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>instances</code></td>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="tcd_pipeline.postprocess.processedinstance.ProcessedInstance" href="#tcd_pipeline.postprocess.processedinstance.ProcessedInstance">ProcessedInstance</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of instances to store.</p>
            </div>
          </td>
          <td>
                <code>[]</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>image_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to image. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>categories</code></td>
          <td>
                <code>dict of int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>str, optional): Class map from ID to name. Defaults to None</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>metadata</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Arbitrary metadata to store in the file. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>COCO format dictionary that is stored to disk, for reference</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dump_instances_coco</span><span class="p">(</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">instances</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">ProcessedInstance</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">image_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">categories</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store a list of instances as a COCO formatted JSON file.</span>

<span class="sd">    If an image path is provided then some info will be stored in the file. This utility</span>
<span class="sd">    is designed to aid with serialising tiled predictions. Typically COCO</span>
<span class="sd">    format results just reference an image ID, however for predictions over</span>
<span class="sd">    large orthomosaics we typically only have a single image, so the ID is</span>
<span class="sd">    set here to zero and we provide information in the annotation file</span>
<span class="sd">    directly. This is just for compatibility.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path (str): Path to output json file. Intermediate folders</span>
<span class="sd">                           will be created if necessary.</span>
<span class="sd">        instances (list[ProcessedInstance]): List of instances to store.</span>
<span class="sd">        image_path (str, optional): Path to image. Defaults to None.</span>
<span class="sd">        categories (dict of int: str, optional): Class map from ID to name. Defaults to None</span>
<span class="sd">        metadata (dict, optional): Arbitrary metadata to store in the file. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        COCO format dictionary that is stored to disk, for reference</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">image_shape</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">image_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">image_dict</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">image_dict</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">image_dict</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
            <span class="n">image_dict</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
            <span class="n">image_shape</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_dict</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_categories</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">category</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">category</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">category</span><span class="p">[</span><span class="s2">&quot;supercategory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">out_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>

        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_categories</span>

    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instances</span><span class="p">):</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">to_coco_dict</span><span class="p">(</span>
            <span class="n">instance_id</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">image_shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;annotations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved predictions for tile to </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="tcd_pipeline.postprocess.processedinstance.non_max_suppression" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">non_max_suppression</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">class_index</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Perform non-maximum suppression on the list of input instances</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>instances</code></td>
          <td>
                <code>list(ProcessedInstance</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>instances to filter</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>class_index</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>class of interest</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>iou_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>IOU threshold Defaults to 0.8.</p>
            </div>
          </td>
          <td>
                <code>0.8</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
                <code>list[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list[int]: List of indices of boxes to keep</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/tcd_pipeline/postprocess/processedinstance.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">non_max_suppression</span><span class="p">(</span>
    <span class="n">instances</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ProcessedInstance</span><span class="p">],</span>
    <span class="n">class_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">iou_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform non-maximum suppression on the list of input instances</span>

<span class="sd">    Args:</span>
<span class="sd">        instances (list(ProcessedInstance)): instances to filter</span>
<span class="sd">        class_index (int): class of interest</span>
<span class="sd">        iou_threshold (float, optional): IOU threshold Defaults to 0.8.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[int]: List of indices of boxes to keep</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">global_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instances</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">class_index</span> <span class="o">!=</span> <span class="n">class_index</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">bounds</span>

        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">minx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxx</span><span class="p">)</span>
        <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">miny</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxy</span><span class="p">)</span>

        <span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
        <span class="n">global_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">global_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">global_indices</span><span class="p">)</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>

        <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">global_indices</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.a7c05c9e.min.js"></script>
      
        <script src="../../../../assets/external/unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
    
  </body>
</html>