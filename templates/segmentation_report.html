<div class="container">
    <section class="sheet padding-10mm">
        <div class="row align-items-start" style="margin-top:1rem; margin-bottom:1rem">
            <div class="col col-md-auto">
                <svg width="100px" height="auto" viewBox="0 0 306 183" xmlns="http://www.w3.org/2000/svg"
                    class="h-full w-auto">
                    <path
                        d="M38.692 78.216h8.507c4.673 0 7.995.403 9.967 1.245 1.972.841 3.578 2.232 4.783 4.172 1.205 1.94 1.825 4.245 1.825 6.88 0 2.782-.657 5.124-2.008 6.991-1.314 1.867-3.322 3.294-6.024 4.246l10.004 18.812h-8.762l-9.493-17.934h-.73v17.934h-8.033V78.216h-.036ZM46.76 94.76h2.519c2.556 0 4.308-.33 5.294-1.025.986-.695 1.46-1.793 1.46-3.367 0-.915-.255-1.72-.73-2.415-.475-.696-1.132-1.172-1.935-1.464-.803-.293-2.264-.44-4.418-.44h-2.19v8.711Zm31.325-16.543h23.075v7.906H86.082v7.649h15.079v7.759H86.082v11.126h15.079v7.906H78.086V78.216Zm61.082 5.746-5.951 5.27c-2.081-2.927-4.235-4.391-6.389-4.391-1.059 0-1.935.292-2.593.841-.657.55-1.022 1.208-1.022 1.904 0 .695.256 1.39.73 2.013.658.841 2.629 2.671 5.915 5.453 3.067 2.562 4.929 4.209 5.586 4.867 1.643 1.648 2.775 3.221 3.469 4.722.693 1.5 1.022 3.147 1.022 4.941 0 3.477-1.205 6.331-3.578 8.601-2.41 2.269-5.513 3.403-9.383 3.403-2.994 0-5.623-.732-7.85-2.232-2.227-1.464-4.162-3.807-5.732-6.954l6.754-4.099c2.045 3.733 4.381 5.599 7.01 5.599 1.388 0 2.556-.402 3.469-1.207.949-.805 1.424-1.72 1.424-2.782 0-.951-.365-1.903-1.059-2.891-.694-.952-2.264-2.416-4.674-4.392-4.6-3.77-7.594-6.661-8.908-8.71-1.351-2.05-2.008-4.1-2.008-6.113 0-2.928 1.132-5.453 3.359-7.54 2.227-2.085 5.002-3.147 8.251-3.147 2.118 0 4.126.476 6.024 1.464 1.826.988 3.907 2.782 6.134 5.38Zm10.113-5.746h23.367v7.942h-7.704v34.404h-8.141V86.158h-7.485v-7.942h-.037Zm53.999-1.098c5.988 0 11.099 2.16 15.407 6.515 4.309 4.355 6.463 9.626 6.463 15.847 0 6.186-2.118 11.419-6.353 15.701-4.235 4.283-9.383 6.405-15.444 6.405-6.353 0-11.61-2.196-15.809-6.588-4.199-4.391-6.28-9.625-6.28-15.664 0-4.063.986-7.76 2.921-11.163 1.972-3.404 4.637-6.075 8.069-8.088 3.395-1.94 7.083-2.965 11.026-2.965Zm-.109 7.906c-3.907 0-7.193 1.354-9.858 4.099-2.665 2.708-3.98 6.185-3.98 10.394 0 4.685 1.68 8.381 5.039 11.126 2.592 2.123 5.586 3.184 8.981 3.184 3.797 0 7.047-1.39 9.748-4.135 2.702-2.782 4.016-6.186 4.016-10.212s-1.35-7.43-4.052-10.248c-2.702-2.818-5.988-4.208-9.894-4.208Zm34.21-6.808h8.507c4.673 0 7.995.403 9.967 1.245 1.971.841 3.578 2.232 4.783 4.172 1.205 1.94 1.825 4.245 1.825 6.88 0 2.782-.657 5.124-2.008 6.991-1.314 1.867-3.322 3.294-6.024 4.246l10.004 18.812h-8.799l-9.493-17.934h-.73v17.934h-8.032V78.216Zm8.032 16.543h2.519c2.556 0 4.308-.33 5.294-1.025.986-.695 1.461-1.793 1.461-3.367 0-.915-.256-1.72-.731-2.415-.474-.696-1.131-1.172-1.935-1.464-.803-.293-2.263-.44-4.417-.44h-2.191v8.711Z"
                        fill="#000"></path>
                    <path
                        d="M4.226 183a4.256 4.256 0 0 1-2.994-1.244 4.24 4.24 0 0 1-1.204-3.477L20.765 3.736A4.288 4.288 0 0 1 22.481.808a4.278 4.278 0 0 1 3.323-.732L280.79 51.828a4.22 4.22 0 0 1 3.25 3.11l21.833 87.107a4.277 4.277 0 0 1-.621 3.441 4.23 4.23 0 0 1-2.957 1.793L4.701 182.963c-.146.037-.329.037-.475.037ZM28.616 9.3 9.045 173.96l287.481-34.513-20.007-79.86L28.615 9.299Z"
                        fill="#FFDE66"></path>
                </svg>
            </div>
            <div class="col">
                <h1>Canopy and Tree Detection Report</h1>
            </div>
        </div>

        <div class="row align-items-start" style="margin-top:1rem; margin-bottom:1rem">
            <div class="col">

                <div class="text-center">
                    <img src="{{ data.raw_image }}" class="rounded" alt="Raw Image"
                        style="width:80%; height: auto; max-height: 75%" />
                </div>

                <div class="card">

                    <div class="card-header primary">General Information</div>
                    <div class="card-body">
                        <ul class="list-group">
                            <li class="list-group-item"><strong>Report generated at:</strong> {{data.timestamp | date :
                                "%Y.%m.%d"}}</li>
                            <li class="list-group-item"><strong>Image:</strong> {{data.image_name}}</li>
                            <li class="list-group-item"><strong>Total Area:</strong> {{data.image_area_m | times :
                                0.0001 | round : 2}} ha</li>
                            <li class="list-group-item"><strong>Resolution (GSD):</strong> {{data.image_res | round :
                                2}} m</li>

                            <li class="list-group-item"><strong>Canopy cover % (non-zero pixels): </strong>
                                {{data.segmentation.canopy_cover
                                | times : 100 | round : 2}}</li>

                            <li class="list-group-item"><strong>Trees detected (open canopy): </strong>
                                {{data.instance_segmentation.number_trees}}</li>
                            <li class="list-group-item"><strong>Shapefile: </strong>
                                {% if data.shapefile %}
                                {{data.shapefile}}</li>
                            <li class="list-group-item"><strong>Shapefile area (ha): </strong>{{ data.shapefile_area_m |
                                times : 0.0001}}
                            </li>
                            {% else %}
                            not provided.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>


            </div>
        </div>
    </section>

    <section class="sheet padding-10mm">
        <div class="row align-items-start" style="margin-top:1rem; margin-bottom:1rem">
            <div class="col justify-content-start">
                <div class="card">
                    <div class="card-header">Canopy Overlay > {{ data.segmentation.confidence_threshold | times : 100 |
                        round : 2 }}% confidence</div>
                    <div class="card-body">

                        <img src={{ data.segmentation.canopy_overlay }} class="card-img-top rounded mx-auto d-block"
                            alt="Canopy Map" style="width:100%; height: auto; max-height: 75%" />
                        <p class="card-text">This overlay image shows canopy predictions (pink) overlaid on the input
                            image.
                            Our model canopy cover estimate is {{data.segmentation.canopy_cover
                            | times: 100 | round : 2}} %.
                            Predictions were made at
                            an
                            attempted tile size of {{ data.segmentation.config.data.tile_size }}x{{
                            data.segmentation.config.data.tile_size }}.
                            Note
                            the GSD figure listed above is the resolution that predictions were performed on, this image
                            may
                            have been resized from the original provided. If a shapefile was provided, then canopy cover
                            is calculated only in that region,
                            otherwise the calculation includes all pixels which are not black (i.e. the invalid regions
                            of the image are ignored).</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="sheet padding-10mm">
        <div class="col">
            <div class="col justify-content-start">
                <div class="card" height="100%">
                    <div class="card-header">Canopy Map</div>
                    <div class="card-body">

                        <img src={{ data.segmentation.canopy_mask }} class="card-img-top rounded mx-auto d-block"
                            alt="Canopy Map" style="width:100%; height: auto; max-height: 75%" />
                        <p class="card-text">This map shows where the model suggests there is tree cover. Typically a
                            threshold of 50-60% would be applied to give a binary map of "tree" vs "not tree"</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="sheet padding-10mm">
        <div class="col">
            <div class="col justify-content-start">
                <div class="card" height="100%">
                    <div class="card-header">Individual Tree Map</div>
                    <div class="card-body">

                        <img src={{ data.instance_segmentation.tcd_overlay }}
                            class="card-img-top rounded mx-auto d-block" alt="TCD Map"
                            style="width:100%; height: auto; max-height: 75%" />
                        <p class="card-text">This map shows where our model has detected
                            {{data.instance_segmentation.number_trees}} individual trees, outlined in pink.
                            This model has not been trained to detect trees in closed canopy. Detected closed canopy
                            regions are
                            marked in yellow for reference.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="sheet padding-10mm">
        <div class="col">
            <div class="col justify-content-start">
                <div class="card" height="100%">
                    <div class="card-header">Individual Tree Map</div>
                    <div class="card-body map-wrapper">
                        <div id="map"></div>
                        <p class="card-text">Please note that the basemap here is provided by Google Maps and the
                            imagery
                            is unlikely to be taken from the same date as the input image.
                        </p>
                    </div>

                    <script type="text/javascript" language="javascript"
                        src="{{ data.instance_segmentation.geojson }}"></script>
                    <script>

                        var map = L.map('map').setView({ lat: "{{data.map_centre.lat}}", lng: "{{data.map_centre.lon}}" }, 13);

                        googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                            maxZoom: 20,
                            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                        });

                        googleSat.addTo(map);

                        var corner1 = L.latLng({ lat: "{{data.map_bounds.lat[0]}}", lon: "{{data.map_bounds.lon[0]}}" })
                        var corner2 = L.latLng({ lat: "{{data.map_bounds.lat[1]}}", lon: "{{data.map_bounds.lon[1]}}" })
                        var bounds = L.latLngBounds(corner1, corner2);

                        map.fitBounds(bounds);

                        var geojson_crs = new L.Proj.CRS("EPSG:3395", "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +type=crs");

                        function coordsToLatLng(coords) {
                            var latLng = geojson_crs.unproject(L.point(coords[0], coords[1]));
                            return latLng;
                        };

                        // load a geotiff and overlay
                        var raw_image = "file:///{{data.raw_image}}";
                        var image = new L.ImageOverlay(
                            url = raw_image,
                            bounds);
                        image.addTo(map);

                        L.geoJSON(tree_shapes, {
                            coordsToLatLng: coordsToLatLng,
                            style: function (feature) {
                                switch (feature.properties.class) {
                                    case 'tree': return { color: "#FE1493" };
                                    case 'canopy': return { color: "#CCFF00" };
                                }
                            },
                            onEachFeature: function (f, l) {
                                l.bindPopup('<pre>' + JSON.stringify(f.properties, null, ' ').replace(/[\{\}"]/g, '') + '</pre>');
                            }
                        }).addTo(map);

                        

                        // https://gis.stackexchange.com/questions/133630/adding-leaflet-legend
                        var legend = L.control({ position: 'bottomleft' });
                        legend.onAdd = function (map) {

                            var div = L.DomUtil.create('div', 'legend');
                            labels = ['<strong>Categories</strong>'],
                                categories = ['Tree', 'Canopy'];
                            colors = ["#FE1493", "#CCFF00"];

                            for (var i = 0; i < categories.length; i++) {

                                div.innerHTML +=
                                    labels.push(
                                        '<i class="bi bi-circle-fill" style="color:' + colors[i] + '"></i> ' +
                                        (categories[i] ? categories[i] : '+'));

                            }
                            div.innerHTML = labels.join('<br>');
                            return div;
                        };
                        legend.addTo(map);

                    </script>
                </div>
            </div>
        </div>
    </section>



    <section class="sheet padding-10mm">
        <div class="col">
            <div class="col justify-content-start">
                <div class="card" height="100%">
                    <div class="card-header">Crown area histogram</div>
                    <div class="card-body">

                        <img src={{ data.instance_segmentation.area_histogram }}
                            class="card-img-top rounded mx-auto d-block" alt="TCD Map"
                            style="width:100%; height: auto; max-height: 75%" />
                        <p class="card-text">This histogram shows detected tree crown areas. This is calculated as the
                            area of the detected crown in pixels, multiplied by the area-per-pixel (e.g. ground sample
                            distance squared)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="sheet padding-10mm">
        <div class="card">

            <div class="card-header primary">Technical Information</div>
            <div class="card-body">
                This information is used by Restor for quality analysis.
                <ul class="list-group">
                    <li class="list-group-item"><strong>Timestamp:</strong> {{data.timestamp | date : "%Y.%m.%d
                        %H:%M:%S"}}</li>
                    <li class="list-group-item"><strong>Total time (s):</strong> {{data.process_time_s | round :
                        2}}</li>
                    <li class="list-group-item"><strong>Segmentation time (s):</strong> {{data.process_time_seg | round
                        :
                        2}}</li>
                    <li class="list-group-item"><strong>Instance segmentation time (s):</strong>
                        {{data.process_time_inst_seg | round :
                        2}}</li>
                    <li class="list-group-item"><strong>Valid image area (px):</strong> {{data.valid_pixels}}</li>
                    <li class="list-group-item"><strong>CRS:</strong> {{data.image_crs}}</li>
                    <li class="list-group-item"><strong>Segmentation Model architecture:</strong>
                        {{data.segmentation.model_config.model.model }}
                    </li>
                    <li class="list-group-item"><strong>Segmentation Model backbone:</strong>
                        {{data.segmentation.model_config.model.encoder_name }}</li>
                    <li class="list-group-item"><strong>TCD Model architecture:</strong>
                        {{data.instance_segmentation.config.model.architecture }}</li>
                </ul>
            </div>
        </div>
    </section>
</div>